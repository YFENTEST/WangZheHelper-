name: Build iOS Tweak

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git curl build-essential fakeroot perl clang libplist-utils
    
    - name: Install Theos
      run: |
        sudo git clone --recursive https://github.com/theos/theos.git /opt/theos
        sudo chown -R $USER:$USER /opt/theos
    
    - name: Install iOS SDK
      run: |
        cd /opt/theos/sdks
        sudo curl -LO https://github.com/theos/sdks/archive/master.zip
        sudo unzip -q master.zip
        sudo mv sdks-master/* .
        sudo rm -rf sdks-master master.zip
    
    - name: Install ldid
      run: |
        sudo curl -LO https://github.com/ProcursusTeam/ldid/releases/download/v2.1.5-procursus7/ldid_linux_x86_64
        sudo mv ldid_linux_x86_64 /opt/theos/bin/ldid
        sudo chmod +x /opt/theos/bin/ldid
    
    - name: Build tweak
      run: |
        export THEOS=/opt/theos
        export PATH=$THEOS/bin:$PATH
        export THEOS_DEVICE_IP=localhost
        export THEOS_DEVICE_PORT=2222
        export PREFIX=/usr
        export CC=/usr/bin/clang
        export CXX=/usr/bin/clang++
        export LD=/usr/bin/clang
        make clean CC=/usr/bin/clang CXX=/usr/bin/clang++ LD=/usr/bin/clang
        make package CC=/usr/bin/clang CXX=/usr/bin/clang++ LD=/usr/bin/clang THEOS_DEVICE_IP=localhost THEOS_DEVICE_PORT=2222
    
    - name: Upload deb package
      uses: actions/upload-artifact@v4
      with:
        name: WangZheHelper-deb
        path: packages/*.deb
        if-no-files-found: error
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: packages/*.deb
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

