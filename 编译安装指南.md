# 王者荣耀快速充值助手 - 编译安装指南

## 📋 前置准备

### 1. 安装 Theos (在 macOS/Linux)

```bash
# 设置 Theos 路径
export THEOS=~/theos

# 克隆 Theos
git clone --recursive https://github.com/theos/theos.git $THEOS

# 将 THEOS 添加到环境变量（可选）
echo "export THEOS=~/theos" >> ~/.bashrc  # 或 ~/.zshrc
source ~/.bashrc  # 或 ~/.zshrc
```

### 2. 安装 iOS SDK

```bash
# 下载并解压 iOS SDK
# 从 https://github.com/theos/sdks 下载对应的 SDK
cd $THEOS/sdks
git clone https://github.com/theos/sdks.git ./
```

### 3. 安装编译工具

```bash
# macOS (需要 Xcode Command Line Tools)
xcode-select --install

# Linux (Ubuntu/Debian)
sudo apt-get install clang build-essential fakeroot git perl
```

### 4. 配置 SSH 连接到设备

```bash
# 确保设备已越狱并安装了 OpenSSH
# 默认密码通常是 "alpine"

# 测试连接
ssh root@设备IP
```

## 🔨 编译步骤

### 方法一: 直接编译安装（推荐）

```bash
# 1. 进入项目目录
cd /path/to/wangzhehelper

# 2. 清理之前的编译文件
make clean

# 3. 编译项目
make

# 4. 打包 deb
make package

# 5. 安装到设备（需要 SSH 连接）
# 方式 A: 自动安装
make install THEOS_DEVICE_IP=设备IP THEOS_DEVICE_PORT=22

# 方式 B: 手动安装
# deb 文件会在 packages/ 目录下
# 使用 scp 或 Filza 复制到设备并安装
```

### 方法二: 分步骤编译

```bash
# 1. 编译主 Tweak
make clean
make

# 2. 编译 Preferences Bundle
cd wzhelperprefs
make clean
make
cd ..

# 3. 打包
make package

# 4. 查看生成的 deb 包
ls -lh packages/
```

## 📱 安装到设备

### 方法一: 通过 make install

```bash
# 确保设备通过 WiFi/USB 连接，并且已启用 SSH
make install THEOS_DEVICE_IP=192.168.1.100 THEOS_DEVICE_PORT=22
```

### 方法二: 手动安装

```bash
# 1. 找到生成的 deb 文件
ls packages/com.yourname.wangzhehelper_*.deb

# 2. 复制到设备
scp packages/com.yourname.wangzhehelper_*.deb root@设备IP:/var/root/

# 3. SSH 到设备并安装
ssh root@设备IP
dpkg -i /var/root/com.yourname.wangzhehelper_*.deb
killall -9 SpringBoard
```

### 方法三: 通过 Filza

1. 将 `packages/` 目录下的 `.deb` 文件传输到设备
2. 使用 Filza 打开 `.deb` 文件
3. 点击右上角的"安装"
4. 等待安装完成后注销设备

## 🔧 常见编译问题

### 问题 1: 找不到 Theos

```bash
# 错误信息: make: /makefiles/common.mk: No such file or directory

# 解决方法: 设置 THEOS 环境变量
export THEOS=~/theos
# 或在 Makefile 中取消注释并设置 THEOS 路径
```

### 问题 2: SDK 版本问题

```bash
# 错误信息: unable to find SDK

# 解决方法: 检查 SDK 是否安装
ls $THEOS/sdks/

# 或修改 Makefile 中的 TARGET 为已安装的 SDK 版本
TARGET := iphone:clang:13.0:11.0
```

### 问题 3: 权限问题

```bash
# 错误信息: Permission denied

# 解决方法: 添加执行权限
chmod +x $THEOS/bin/*
```

### 问题 4: SSH 连接失败

```bash
# 错误信息: Connection refused

# 解决方法:
# 1. 确保设备已安装 OpenSSH
# 2. 检查防火墙设置
# 3. 确认 IP 地址正确
# 4. 尝试手动 SSH 连接测试
ssh root@设备IP
```

## ⚙️ 自定义配置

### 修改 Bundle ID

编辑 `control` 文件：

```
Package: com.yourname.wangzhehelper  # 改成你的包名
Maintainer: Your Name <your.email@example.com>
```

同时修改 `Makefile` 中的相关配置。

### 修改充值档位

编辑 `Tweak.x`，找到 `setupRechargeOptions` 方法：

```objective-c
NSArray *products = @[
    @{@"title": @"60点券", @"productId": @"com.tencent.smoba60_60", @"price": @6.0},
    // 添加或修改档位...
];
```

### 修改悬浮按钮样式

在 `Tweak.x` 的 `addFloatingButton` 方法中修改：

```objective-c
floatingButton.backgroundColor = [UIColor colorWithRed:0.2 green:0.6 blue:1.0 alpha:0.9];
[floatingButton setTitle:@"💎" forState:UIControlStateNormal];  // 修改图标
```

## 🧪 测试和调试

### 查看实时日志

```bash
# SSH 到设备
ssh root@设备IP

# 查看插件日志
tail -f /var/log/syslog | grep WZHelper

# 或使用更详细的日志
deviceconsole | grep WZHelper
```

### 重新加载插件

```bash
# SSH 到设备后执行
killall -9 SpringBoard

# 或只杀掉王者荣耀进程
killall -9 smoba
```

### 检查插件是否加载

```bash
# SSH 到设备
ssh root@设备IP

# 查看已加载的动态库
ls -la /Library/MobileSubstrate/DynamicLibraries/

# 应该看到:
# WangZheHelper.dylib
# WangZheHelper.plist
```

## 📦 发布 deb 包

### 1. 修改版本号

编辑 `control` 文件：

```
Version: 1.0.1  # 更新版本号
```

### 2. 编译并打包

```bash
make clean
make package
```

### 3. 生成的文件

```
packages/com.yourname.wangzhehelper_1.0.1_iphoneos-arm.deb
```

### 4. 上传到仓库

如果你有自己的 Cydia/Sileo 仓库，可以上传 deb 包。

## 🔄 更新插件

### 本地更新

```bash
# 1. 修改代码
# 2. 更新版本号（control 文件）
# 3. 重新编译
make clean
make package

# 4. 安装新版本
make install THEOS_DEVICE_IP=设备IP
```

### 用户更新

用户可以通过以下方式更新：

1. 从仓库更新（如果已发布）
2. 手动下载新的 deb 包安装
3. 使用 Filza 安装新版本

## 🎯 Windows 用户

Windows 用户可以使用 WSL (Windows Subsystem for Linux) 进行编译：

```bash
# 1. 安装 WSL2
wsl --install

# 2. 在 WSL 中安装 Theos（按照 Linux 步骤）
# 3. 按照上述步骤编译

# 注意: 生成的 deb 文件在 WSL 文件系统中
# 可以通过 \\wsl$ 访问
```

## 📚 相关资源

- [Theos 官方文档](https://theos.dev/docs/)
- [iOS 越狱开发教程](https://iphonedev.wiki/)
- [Cydia Substrate 文档](http://www.cydiasubstrate.com/id/264d6581-a762-4343-9605-729ef12ff0af/)

## 💡 开发技巧

### 快速迭代

创建一个编译安装脚本 `build.sh`：

```bash
#!/bin/bash
make clean
make package
make install THEOS_DEVICE_IP=你的设备IP
```

```bash
chmod +x build.sh
./build.sh
```

### 远程日志查看

创建 `log.sh`：

```bash
#!/bin/bash
ssh root@你的设备IP "tail -f /var/log/syslog" | grep WZHelper
```

---

如有问题，请在 GitHub 提交 Issue。

